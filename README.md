# Dynamic Stopper for Spot

This repository contains a Python script extending Boston Dynamics Spot’s Autowalk with **dynamic runtime behaviors**.

The code loads a recorded Autowalk mission and injects dynamic pauses, sidesteps, and image capture into the robot’s navigation. It also supports running background CPU tasks (e.g., lightweight inference threads such as YOLO) to simulate real-time decision making.

Developed for research and experimental purposes in the context of autonomous robotics and dynamic navigation.

ΝΟΤΕ: based on this documentation https://dev.bostondynamics.com/

---

## Features

### 1. Periodic Dynamic Pauses  
**Goal:** Stop the robot every *M* meters along the path for *N* seconds.  
**Techniques:**  
- ODOM distance tracking  
- Mission keepalive handling  
- Controlled stop commands  

---

### 2. Lateral Sidestep Maneuvers  
**Goal:** Shift the robot sideways (left, right, or alternating) by a given distance.  
**Techniques:**  
- Body-frame velocity command (v_y)  
- Configurable sidestep magnitude and speed  
- Alternate or fixed direction policy  

---

### 3. Image Capture at Pauses  
**Goal:** Capture and save images from Spot’s cameras at each pause.  
**Techniques:**  
- ImageClient API with multiple sources  
- JPEG/PNG saving with timestamps  
- Directory auto-creation per pause  

---

### 4. Background CPU Load Thread  
**Goal:** Simulate lightweight background tasks (e.g., YOLO object detection).  
**Techniques:**  
- Configurable load percentage and cycle  
- NumPy operations for CPU/FPU activity  
- Runs in parallel thread during mission  

---

## Requirements

- **Python 3.8+**  
- **Boston Dynamics Spot SDK**  
- External libraries:  
  - `numpy`  
  - `opencv-python`  
  - `protobuf`  
  - Stdlib: argparse, logging, math, os, sys, time, threading, typing
  - Imaging/numeric: opencv-python (cv2), numpy
  - Protobuf: google.protobuf.message
  - Spot SDK: LeaseClient, LeaseKeepAlive, PowerClient, power_on_motors,
              RobotCommandClient, RobotCommandBuilder, blocking_stand, RobotStateClient,
              GraphNavClient, AutowalkClient, ImageClient, build_image_request, MissionClient,
              TimedOutError
  - Spot API protos: image_pb2, walks_pb2, graph_nav_pb2, map_pb2, mission_pb2, nav_pb2

Frame helpers: ODOM_FRAME_NAME, BODY_FRAME_NAME, get_se3_a_tform_b or get_a_tform_b (SDK-version safe)
---

## Arguments (core)
Flag	Description
--hostname	Spot hostname or IP (required)
--walk_directory	Path to the recorded .walk directory (required)
--walk_filename	File inside missions/ to load (default: autogenerated.walk)
--stop-every-m	Pause trigger distance in meters (default: 5.0)
--pause-sec	Pause duration (default: 2.0)
--mission-timeout	Keepalive window (seconds) for mission playback (default: 2.0)
--sidestep-m	Lateral shift in meters; + left, - right (default: 1.5)
--sidestep-speed	Lateral velocity (m/s) (default: 0.3)
--sidestep-mode	alternate | left | right (default: alternate)
--save-images	Enable image capture at each pause
--image-sources	Repeat per camera source (e.g., frontleft_fisheye_image)
--jpeg-quality-percent	JPEG quality (default: 85)
--save-dir	Output directory for captures (default: timestamped under .walk)
--bg-load-pct	Background CPU load fraction 0.0–1.0 (default: 0)
--bg-cycle-ms	Background load cycle (ms) (default: 100)
-v/--verbose	Verbose logging

## YOLO / Decision hooks

Replace the background load thread with a detector worker.
Example logic in the loop:

Pause every M meters or when detector reports “tree” with confidence > τ.

On detection: stop, capture, sidestep (or run an arm/pose action), then resume mission.

## How it works (high level)

Setup: Authenticate, time-sync, create all clients (Lease/Power/State/Command/Mission/GraphNav/Autowalk/Image).

Map upload: Clear GraphNav, upload graph + snapshots from your .walk directory.

Compile mission: Load missions/<walk> via AutowalkClient.load_autowalk().

Ready: Power on, blocking_stand(), optionally request fiducial localization.

Loop:

Track ODOM distance (BODY in ODOM XY) and accumulate meters.

Keepalive the mission periodically; withhold it during pauses to hold position.

When accum_m >= --stop-every-m: stop → sidestep → (optional) photo burst → open pause window.

After pause, resume keepalive; GraphNav re-localizes and continues to the next waypoint.

## Tips & Safety

In production, prefer cooperative lease sharing instead of take().

Test in clear areas; verify sidestep distances/speeds are safe for your environment.

Good texture/fiducials/lighting improve GraphNav robustness, especially after sidesteps.

ODOM drift is small and suitable for relative triggers (every M meters).

## Troubleshooting

Mission won’t start: Ensure graph/snapshots uploaded; Autowalk compiled OK; credentials valid.

Robot “stays still”: You might be inside a pause window; check --mission-timeout and keepalive timing.

No images: Verify --save-images, source names, and Image service connectivity.

Re-localization fails: Try fiducial init (keep --noloc off), re-record weak areas, improve lighting.

## Example Configuration

An example JSON launch configuration is provided:

```json
{
  "version": "0.2.0",
  "configurations": [
    {
      "name": "DynamicStopper — sidestep + light BG load",
      "type": "debugpy",
      "request": "launch",
      "program": "${workspaceFolder}/examples/dynamic_stopper.py",
      "console": "externalTerminal",
      "cwd": "${workspaceFolder}",
      "args": [
        "--hostname", "",                                      // <— CHANGE
        "--walk_directory", "${workspaceFolder}/",  // <— CHANGE
        "--walk_filename", "",                        // or your .walk file

        "--stop-every-m", "5.0",
        "--pause-sec", "2.0",
        "--mission-timeout", "2.0",

        "--sidestep-m", "1",                                          // lateral shift meters
        "--sidestep-speed", "0.3",                                      // m/s
        "--sidestep-mode", "alternate",                                 // alternate | left | right

        // Optional photo capture
        "--save-images",
        "--image-sources", "frontleft_fisheye_image",
        "--image-sources", "frontright_fisheye_image",
        "--jpeg-quality-percent", "85",
        "--save-dir", "${workspaceFolder}/",

        // NEW: light background CPU load (10% with 100 ms cycle)
        "--bg-load-pct", "0.10",                                        // 0.0 disables
        "--bg-cycle-ms", "100"                                          // cycle period
      ],
      "env": {
        "BOSDYN_USERNAME": "",
        "BOSDYN_PASSWORD": ""
      }
    }
  ]
}

