# Dynamic Stopper — Autowalk + Runtime Pauses/Sidestep + Photos

Inject **dynamic behavior** into a recorded Autowalk mission on Boston Dynamics Spot:  
pause every _M_ meters, take photos, perform lateral sidesteps (left/right/alternate), and hook in a background
thread (e.g., for YOLO). The robot still benefits from Spot’s obstacle avoidance, while GraphNav keeps it localized
and on route.
NOTE: Based on the documentation https://dev.bostondynamics.com/
---

## What it does

- **Dynamic stops**: pause every `--stop-every-m` meters for `--pause-sec` seconds (no edits to the `.walk`).
- **On-pause actions**: capture images from chosen cameras; perform **sidestep** by `--sidestep-m` at `--sidestep-speed`.
- **Background work**: lightweight background thread for CPU tasks (replace with **YOLO** to drive decisions).
- **Mission continuity**: mission is kept alive via keepalives; during pauses keepalives are withheld, then resumed.
- **GraphNav resilience**: after a sidestep, GraphNav re-localizes and guides Spot back to the route.
- **Obstacle handling**: Spot’s mobility avoids people/rocks/etc. while your dynamic logic runs on top.

---

## Prerequisites

- Python 3.8+
- A **recorded Autowalk** directory (`.walk`) created via Spot tablet or SDK  
  (must contain: `graph`, `waypoint_snapshots/`, `edge_snapshots/`, `missions/<your.walk>`)
- Network access to the robot + valid SDK credentials (`BOSDYN_USERNAME`, `BOSDYN_PASSWORD`)
- GraphNav-enabled Spot with appropriate licenses

**Python packages**
```bash
pip install bosdyn-client bosdyn-mission protobuf numpy opencv-python

Imports used

Stdlib: argparse, logging, math, os, sys, time, threading, typing

Imaging/numeric: opencv-python (cv2), numpy

Protobuf: google.protobuf.message

Spot SDK: LeaseClient, LeaseKeepAlive, PowerClient, power_on_motors,
RobotCommandClient, RobotCommandBuilder, blocking_stand, RobotStateClient,
GraphNavClient, AutowalkClient, ImageClient, build_image_request, MissionClient,
TimedOutError

Spot API protos: image_pb2, walks_pb2, graph_nav_pb2, map_pb2, mission_pb2, nav_pb2

Frame helpers: ODOM_FRAME_NAME, BODY_FRAME_NAME, get_se3_a_tform_b or get_a_tform_b (SDK-version safe)

## Arguments
| Flag                     | Description                                                        |
| ------------------------ | ------------------------------------------------------------------ |
| `--hostname`             | Spot hostname or IP (required)                                     |
| `--walk_directory`       | Path to the recorded `.walk` directory (required)                  |
| `--walk_filename`        | File inside `missions/` to load (default: `autogenerated.walk`)    |
| `--stop-every-m`         | Pause trigger distance in meters (default: `5.0`)                  |
| `--pause-sec`            | Pause duration (default: `2.0`)                                    |
| `--mission-timeout`      | Keepalive window (seconds) for mission playback (default: `2.0`)   |
| `--sidestep-m`           | Lateral shift in meters; `+` left, `-` right (default: `1.5`)      |
| `--sidestep-speed`       | Lateral velocity (m/s) (default: `0.3`)                            |
| `--sidestep-mode`        | `alternate` | `left` | `right` (default: `alternate`)              |
| `--save-images`          | Enable image capture at each pause                                 |
| `--image-sources`        | Repeat per camera source (e.g., `frontleft_fisheye_image`)         |
| `--jpeg-quality-percent` | JPEG quality (default: `85`)                                       |
| `--save-dir`             | Output directory for captures (default: timestamped under `.walk`) |
| `--bg-load-pct`          | Background CPU load fraction `0.0–1.0` (default: `0`)              |
| `--bg-cycle-ms`          | Background load cycle (ms) (default: `100`)                        |
| `-v/--verbose`           | Verbose logging                                                    |

## How it works (high level)

Setup: Authenticate, time-sync, create all clients (Lease/Power/State/Command/Mission/GraphNav/Autowalk/Image).

Map upload: Clear GraphNav, upload graph + snapshots from your .walk directory.

Compile mission: Load missions/<walk> via AutowalkClient.load_autowalk().

Ready: Power on, blocking_stand(), optionally request fiducial localization.

Loop:

Track ODOM distance (BODY in ODOM XY) and accumulate meters.

Keepalive the mission periodically; withhold it during pauses to hold position.

When accum_m >= --stop-every-m: stop → sidestep → (optional) photo burst → open pause window.

After pause, resume keepalive; GraphNav re-localizes and continues to the next waypoint.

## YOLO / Decision hooks

Replace the background load thread with a detector worker.
Example logic in the loop:

Pause every M meters or when detector reports “tree” with confidence > τ.

On detection: stop, capture, sidestep (or run an arm/pose action), then resume mission.

## JSON example

{
  "version": "0.2.0",
  "configurations": [
    {
      "name": "DynamicStopper — sidestep + light BG load",
      "type": "debugpy",
      "request": "launch",
      "program": "${workspaceFolder}/examples/dynamic_stopper.py",
      "console": "externalTerminal",
      "cwd": "${workspaceFolder}",
      "args": [
        "--hostname", "",  // <— CHANGE
        "--walk_directory", "${workspaceFolder}/recordings/Vasilis_Outside_22_08_2025_Test2.walk",  // <— CHANGE
        "--walk_filename", "",
        "--stop-every-m", "5.0",
        "--pause-sec", "2.0",
        "--mission-timeout", "2.0",
        "--sidestep-m", "1",
        "--sidestep-speed", "0.3",
        "--sidestep-mode", "alternate",
        "--save-images",
        "--image-sources", "frontleft_fisheye_image",
        "--image-sources", "frontright_fisheye_image",
        "--jpeg-quality-percent", "85",
        "--save-dir", "${workspaceFolder}/recordings/Vasilis_Outside_22_08_2025_Test2.walk/captures",
        "--bg-load-pct", "0.10",
        "--bg-cycle-ms", "100"
      ],
      "env": {
        "BOSDYN_USERNAME": "",
        "BOSDYN_PASSWORD": ""
      }
    }
  ]
}

## Tips & Safety

In production, prefer cooperative lease sharing instead of take().

Test in clear areas; verify sidestep distances/speeds are safe for your environment.

Good texture/fiducials/lighting improve GraphNav robustness, especially after sidesteps.

ODOM drift is small and suitable for relative triggers (every M meters).

## Troubleshooting

Mission won’t start: Ensure graph/snapshots uploaded; Autowalk compiled OK; credentials valid.

Robot “stays still”: You might be inside a pause window; check --mission-timeout and keepalive timing.

No images: Verify --save-images, source names, and Image service connectivity.

Re-localization fails: Try fiducial init (keep --noloc off), re-record weak areas, improve lighting.

